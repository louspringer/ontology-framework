@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix bfg: <http://ontologies.louspringer.com/build_process#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .

# Ontology Definition
bfg: a owl:Ontology ;
    rdfs:label "Build Process Ontology" ;
    rdfs:comment "An ontology for describing build and deployment processes" ;
    owl:versionInfo "1.0.0" .

# Classes
bfg:BuildProcess rdf:type owl:Class ;
    rdfs:label "Build Process" ;
    rdfs:comment "A process for building and deploying software" ;
    owl:versionInfo "1.0.0" .

bfg:BuildStep rdf:type owl:Class ;
    rdfs:label "Build Step" ;
    rdfs:comment "A step in the build process" .

bfg:VirtualMachine rdf:type owl:Class ;
    rdfs:label "Virtual Machine" ;
    rdfs:comment "A virtual machine configuration" .

bfg:ResourceGroup rdf:type owl:Class ;
    rdfs:label "Resource Group" ;
    rdfs:comment "An Azure resource group" .

# Properties
bfg:hasCommand rdf:type owl:DatatypeProperty ;
    rdfs:domain bfg:BuildStep ;
    rdfs:range xsd:string .

bfg:hasStepOrder rdf:type owl:DatatypeProperty ;
    rdfs:domain bfg:BuildStep ;
    rdfs:range xsd:integer .

bfg:hasAutoConfirm rdf:type owl:DatatypeProperty ;
    rdfs:domain bfg:BuildStep ;
    rdfs:range xsd:boolean .

bfg:hasEnvironmentVariable rdf:type owl:DatatypeProperty ;
    rdfs:domain bfg:BuildProcess ;
    rdfs:range xsd:string .

bfg:hasSize rdf:type owl:DatatypeProperty ;
    rdfs:domain bfg:VirtualMachine ;
    rdfs:range xsd:string .

bfg:hasLocation rdf:type owl:DatatypeProperty ;
    rdfs:domain bfg:ResourceGroup ;
    rdfs:range xsd:string .

bfg:hasImage rdf:type owl:DatatypeProperty ;
    rdfs:domain bfg:VirtualMachine ;
    rdfs:range xsd:string .

bfg:hasEvictionPolicy rdf:type owl:DatatypeProperty ;
    rdfs:domain bfg:VirtualMachine ;
    rdfs:range xsd:string .

bfg:hasPriority rdf:type owl:DatatypeProperty ;
    rdfs:domain bfg:VirtualMachine ;
    rdfs:range xsd:string .

# Property Characteristics
bfg:hasStepOrder rdf:type owl:FunctionalProperty ;
    rdfs:label "has step order" ;
    rdfs:comment "Specifies the order of execution for a build step" .

bfg:hasCommand rdf:type owl:FunctionalProperty ;
    rdfs:label "has command" ;
    rdfs:comment "Specifies the command to execute for a build step" .

bfg:hasAutoConfirm rdf:type owl:FunctionalProperty ;
    rdfs:label "has auto confirm" ;
    rdfs:comment "Specifies whether the step should auto-confirm prompts" .

bfg:hasEnvironmentVariable rdf:type owl:DatatypeProperty ;
    rdfs:label "has environment variable" ;
    rdfs:comment "Specifies an environment variable for the build process" .

bfg:hasSize rdf:type owl:FunctionalProperty ;
    rdfs:label "has size" ;
    rdfs:comment "Specifies the size of a virtual machine" .

bfg:hasLocation rdf:type owl:FunctionalProperty ;
    rdfs:label "has location" ;
    rdfs:comment "Specifies the location of a resource group" .

bfg:hasImage rdf:type owl:FunctionalProperty ;
    rdfs:label "has image" ;
    rdfs:comment "Specifies the image for a virtual machine" .

bfg:hasEvictionPolicy rdf:type owl:FunctionalProperty ;
    rdfs:label "has eviction policy" ;
    rdfs:comment "Specifies the eviction policy for a virtual machine" .

bfg:hasPriority rdf:type owl:FunctionalProperty ;
    rdfs:label "has priority" ;
    rdfs:comment "Specifies the priority for a virtual machine" .

# Build Process Instance
bfg:buildProcess rdf:type bfg:BuildProcess ;
    bfg:hasEnvironmentVariable "VM_IMAGE=Canonical:0001-com-ubuntu-server-jammy:22_04-lts:latest" ;
    bfg:hasEnvironmentVariable "VM_SIZE=Standard_D2_v2" ;
    bfg:hasEnvironmentVariable "ADMIN_USERNAME=azureuser" ;
    bfg:hasEnvironmentVariable "LOCATION=eastasia" ;
    bfg:hasEnvironmentVariable "VM_NAME=pdf-processor-vm" ;
    bfg:hasEnvironmentVariable "ACR_NAME=pdfprocessor1234" ;
    bfg:hasEnvironmentVariable "RESOURCE_GROUP=pdf-processor-rg" .

# Build Steps
bfg:cleanupStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "az group delete --name $RESOURCE_GROUP --yes" ;
    bfg:hasStepOrder 1 ;
    bfg:hasAutoConfirm true .

bfg:createResourceGroupStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "az group create --name $RESOURCE_GROUP --location $LOCATION" ;
    bfg:hasStepOrder 2 ;
    bfg:hasAutoConfirm true .

bfg:createNetworkStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "az network vnet create --resource-group $RESOURCE_GROUP --name ${VM_NAME}VNET --address-prefix 10.0.0.0/16 --subnet-name ${VM_NAME}Subnet --subnet-prefix 10.0.0.0/24" ;
    bfg:hasStepOrder 3 ;
    bfg:hasAutoConfirm true .

bfg:deleteNSGStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "az network nsg delete --resource-group $RESOURCE_GROUP --name ${VM_NAME}NSG --yes" ;
    bfg:hasStepOrder 4 ;
    bfg:hasAutoConfirm true .

bfg:createNSGStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "az network nsg create --resource-group $RESOURCE_GROUP --name ${VM_NAME}NSG" ;
    bfg:hasStepOrder 5 ;
    bfg:hasAutoConfirm true .

bfg:createSSHRuleStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "az network nsg rule create --resource-group $RESOURCE_GROUP --nsg-name ${VM_NAME}NSG --name AllowSSH --protocol tcp --priority 1000 --destination-port-range 22 --access allow" ;
    bfg:hasStepOrder 6 ;
    bfg:hasAutoConfirm true .

bfg:createPublicIPStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "az network public-ip create --resource-group $RESOURCE_GROUP --name ${VM_NAME}PublicIP --sku Standard --version IPv4" ;
    bfg:hasStepOrder 7 ;
    bfg:hasAutoConfirm true .

bfg:createVMStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "az vm create --resource-group $RESOURCE_GROUP --name $VM_NAME --image $VM_IMAGE --size Standard_D2_v2 --admin-username $ADMIN_USERNAME --ssh-key-values ~/.ssh/pdf-processor-vm_key.pub --priority Spot --eviction-policy Deallocate --public-ip-address ${VM_NAME}PublicIP --vnet-name ${VM_NAME}VNET --subnet ${VM_NAME}Subnet --nsg ${VM_NAME}NSG" ;
    bfg:hasStepOrder 8 ;
    bfg:hasAutoConfirm true .

bfg:createACRStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "az acr create --resource-group $RESOURCE_GROUP --name $ACR_NAME --sku Basic" ;
    bfg:hasStepOrder 8 ;
    bfg:hasAutoConfirm true .

bfg:installDockerStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "ssh -i ~/.ssh/pdf-processor-vm_key $ADMIN_USERNAME@$VM_IP 'sudo apt-get update && sudo apt-get install -y docker.io'" ;
    bfg:hasStepOrder 9 ;
    bfg:hasAutoConfirm true .

bfg:setupAppStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "ssh -i ~/.ssh/pdf-processor-vm_key $ADMIN_USERNAME@$VM_IP 'mkdir -p /app'" ;
    bfg:hasStepOrder 10 ;
    bfg:hasAutoConfirm true .

bfg:copyFilesStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "scp -i ~/.ssh/pdf-processor-vm_key -r ./* $ADMIN_USERNAME@$VM_IP:/app/" ;
    bfg:hasStepOrder 11 ;
    bfg:hasAutoConfirm true .

bfg:loginACRStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "ssh -i ~/.ssh/pdf-processor-vm_key $ADMIN_USERNAME@$VM_IP 'docker login $ACR_NAME.azurecr.io -u $ACR_USERNAME -p $ACR_PASSWORD'" ;
    bfg:hasStepOrder 12 ;
    bfg:hasAutoConfirm true .

bfg:buildPushImageStep rdf:type bfg:BuildStep ;
    bfg:hasCommand "ssh -i ~/.ssh/pdf-processor-vm_key $ADMIN_USERNAME@$VM_IP 'cd /app && docker build -t $ACR_NAME.azurecr.io/pdf-processor:latest . && docker push $ACR_NAME.azurecr.io/pdf-processor:latest'" ;
    bfg:hasStepOrder 13 ;
    bfg:hasAutoConfirm true .

# SHACL Shapes
bfg:BuildStepShape a sh:NodeShape ;
    sh:targetClass bfg:BuildStep ;
    sh:property [
        sh:path bfg:hasCommand ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Build step must have exactly one command"
    ] ,
    [
        sh:path bfg:hasStepOrder ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:integer ;
        sh:message "Build step must have exactly one order number"
    ] ,
    [
        sh:path bfg:hasAutoConfirm ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:boolean ;
        sh:message "Build step must specify auto-confirm setting"
    ] .

bfg:VirtualMachineShape a sh:NodeShape ;
    sh:targetClass bfg:VirtualMachine ;
    sh:property [
        sh:path bfg:hasSize ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Virtual machine must have exactly one size"
    ] ,
    [
        sh:path bfg:hasImage ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Virtual machine must have exactly one image"
    ] ,
    [
        sh:path bfg:hasEvictionPolicy ;
        sh:minCount 0 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Virtual machine may have at most one eviction policy"
    ] .

bfg:ResourceGroupShape a sh:NodeShape ;
    sh:targetClass bfg:ResourceGroup ;
    sh:property [
        sh:path bfg:hasLocation ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:datatype xsd:string ;
        sh:message "Resource group must have exactly one location"
    ] . 